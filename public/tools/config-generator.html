<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sing-box Trojan é…ç½®ç”Ÿæˆå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        input[type="text"],
        input[type="number"],
        input[type="email"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .password-group {
            display: flex;
            gap: 10px;
        }

        .password-input {
            flex: 1;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .server-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }

        .server-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .server-title {
            font-size: 1.2em;
            color: #333;
            font-weight: 600;
        }

        .remove-server {
            background: #ff4757;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .config-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.5;
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #1976d2;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ sing-box Trojan é…ç½®ç”Ÿæˆå™¨</h1>
        
        <div class="card">
            <div class="alert">
                ğŸ’¡ è¿™ä¸ªå·¥å…·å¸®åŠ©ä½ å¿«é€Ÿç”Ÿæˆ sing-box çš„ Trojan èŠ‚ç‚¹é…ç½®ï¼Œè‡ªåŠ¨ç”Ÿæˆå¼ºå¯†ç ï¼Œå¹¶å¯¼å‡ºå®Œæ•´çš„é…ç½®æ–‡ä»¶ã€‚
            </div>
            
            <h2 class="section-title">åŸºç¡€è®¾ç½®</h2>
            
            <div class="form-group">
                <label for="subscriptionKey">è®¢é˜…å¯†é’¥ï¼ˆç”¨äºä¿æŠ¤è®¢é˜…é“¾æ¥ï¼‰</label>
                <div class="password-group">
                    <input type="text" id="subscriptionKey" class="password-input" placeholder="ç•™ç©ºå°†è‡ªåŠ¨ç”Ÿæˆ">
                    <button type="button" class="btn btn-secondary" id="genSubKey">ç”Ÿæˆå¯†é’¥</button>
                </div>
            </div>

            <div class="form-group">
                <label for="apiSecret">API å¯†é’¥ï¼ˆç”¨äº Web UIï¼‰</label>
                <div class="password-group">
                    <input type="text" id="apiSecret" class="password-input" placeholder="ç•™ç©ºå°†è‡ªåŠ¨ç”Ÿæˆ">
                    <button type="button" class="btn btn-secondary" id="genApiKey">ç”Ÿæˆå¯†é’¥</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h2 class="section-title">æœåŠ¡å™¨é…ç½®</h2>
            
            <div id="servers-container">
                <!-- æœåŠ¡å™¨é…ç½®å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
            </div>
            
            <button type="button" class="btn btn-primary" id="addServerBtn">+ æ·»åŠ æœåŠ¡å™¨</button>
        </div>

        <div class="card">
            <h2 class="section-title">ç”Ÿæˆé…ç½®</h2>
            
            <button type="button" class="btn btn-success" id="generateBtn" style="width: 100%; font-size: 18px;">
                ğŸ¯ ç”Ÿæˆæ‰€æœ‰é…ç½®
            </button>
        </div>

        <div class="card" id="output-section" style="display: none;">
            <h2 class="section-title">ç”Ÿæˆçš„é…ç½®æ–‡ä»¶</h2>
            
            <div id="config-output" class="config-output">
                <!-- é…ç½®è¾“å‡ºå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
            </div>
            
            <div style="margin-top: 20px;">
                <button type="button" class="btn btn-primary" id="copyBtn">ğŸ“‹ å¤åˆ¶é…ç½®</button>
                <button type="button" class="btn btn-secondary" id="downloadBtn">ğŸ’¾ ä¸‹è½½é…ç½®</button>
            </div>
        </div>
    </div>

    <script>
        let serverCount = 0;
        let currentConfig = '';

        // ç”Ÿæˆéšæœºå­—ç¬¦ä¸²
        function generateRandomString(length) {
            const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            return result;
        }

        // ç”Ÿæˆå¯†ç 
        function generatePassword(length = 16) {
            const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*';
            let password = '';
            for (let i = 0; i < length; i++) {
                password += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            return password;
        }

        // æ·»åŠ æœåŠ¡å™¨
        function addServer() {
            serverCount++;
            const container = document.getElementById('servers-container');
            const serverDiv = document.createElement('div');
            serverDiv.className = 'server-card';
            serverDiv.id = 'server-' + serverCount;
            
            const locations = ['é¦™æ¸¯', 'ç¾å›½', 'æ—¥æœ¬', 'æ–°åŠ å¡', 'éŸ©å›½', 'å°æ¹¾'];
            const defaultLocation = locations[(serverCount - 1) % locations.length];
            
            const html = `
                <div class="server-header">
                    <div class="server-title">æœåŠ¡å™¨ ${serverCount} - ${defaultLocation}</div>
                    ${serverCount > 1 ? '<button type="button" class="remove-server" data-id="' + serverCount + '">åˆ é™¤</button>' : ''}
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>èŠ‚ç‚¹åç§°</label>
                        <input type="text" id="server-name-${serverCount}" value="${defaultLocation}-${serverCount}" placeholder="ä¾‹å¦‚ï¼šé¦™æ¸¯-HK">
                    </div>
                    <div class="form-group">
                        <label>æœåŠ¡å™¨åŸŸå</label>
                        <input type="text" id="server-domain-${serverCount}" placeholder="ä¾‹å¦‚ï¼šhk.example.com">
                    </div>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>æœåŠ¡å™¨ IPï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" id="server-ip-${serverCount}" placeholder="ä¾‹å¦‚ï¼š1.2.3.4">
                    </div>
                    <div class="form-group">
                        <label>ç«¯å£</label>
                        <input type="number" id="server-port-${serverCount}" value="443" placeholder="443">
                    </div>
                </div>
                <div class="form-group">
                    <label>Trojan å¯†ç </label>
                    <div class="password-group">
                        <input type="text" id="server-password-${serverCount}" class="password-input" value="${generateRandomString(16)}" placeholder="ç•™ç©ºå°†è‡ªåŠ¨ç”Ÿæˆ">
                        <button type="button" class="btn btn-secondary gen-pwd-btn" data-target="server-password-${serverCount}">ç”Ÿæˆå¯†ç </button>
                    </div>
                </div>
                <div class="form-group">
                    <label>è¯ä¹¦é‚®ç®±ï¼ˆLet's Encryptï¼‰</label>
                    <input type="email" id="server-email-${serverCount}" placeholder="your@email.com">
                </div>
            `;
            
            serverDiv.innerHTML = html;
            container.appendChild(serverDiv);
            
            // æ·»åŠ åˆ é™¤æŒ‰é’®äº‹ä»¶
            const removeBtn = serverDiv.querySelector('.remove-server');
            if (removeBtn) {
                removeBtn.addEventListener('click', function() {
                    serverDiv.remove();
                });
            }
            
            // æ·»åŠ ç”Ÿæˆå¯†ç æŒ‰é’®äº‹ä»¶
            const genPwdBtn = serverDiv.querySelector('.gen-pwd-btn');
            if (genPwdBtn) {
                genPwdBtn.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-target');
                    document.getElementById(targetId).value = generateRandomString(16);
                });
            }
        }

        // æ”¶é›†æœåŠ¡å™¨æ•°æ®
        function collectServerData() {
            const servers = [];
            // æ­£ç¡®çš„é€‰æ‹©å™¨ï¼šæŸ¥æ‰¾æ‰€æœ‰ server-name-X çš„è¾“å…¥æ¡†
            const serverElements = document.querySelectorAll('input[id^="server-name-"]');
            
            console.log('æ‰¾åˆ°çš„æœåŠ¡å™¨å…ƒç´ ï¼š', serverElements.length); // è°ƒè¯•ä¿¡æ¯
            
            serverElements.forEach(element => {
                const match = element.id.match(/server-name-(\d+)/);
                if (match) {
                    const num = match[1];
                    const domainElement = document.getElementById('server-domain-' + num);
                    
                    if (domainElement) {
                        const domain = domainElement.value.trim();
                        
                        console.log('æœåŠ¡å™¨ ' + num + ' åŸŸåï¼š', domain); // è°ƒè¯•ä¿¡æ¯
                        
                        if (domain) {
                            servers.push({
                                name: element.value || 'æœåŠ¡å™¨-' + num,
                                domain: domain,
                                ip: document.getElementById('server-ip-' + num).value,
                                port: document.getElementById('server-port-' + num).value || '443',
                                password: document.getElementById('server-password-' + num).value || generateRandomString(16),
                                email: document.getElementById('server-email-' + num).value || 'admin@example.com'
                            });
                        }
                    }
                }
            });
            
            console.log('æ”¶é›†åˆ°çš„æœåŠ¡å™¨æ•°æ®ï¼š', servers); // è°ƒè¯•ä¿¡æ¯
            return servers;
        }

        // ç”ŸæˆæœåŠ¡å™¨é…ç½®
        function generateServerConfig(server) {
            return {
                "log": {
                    "level": "info",
                    "timestamp": true
                },
                "inbounds": [
                    {
                        "type": "trojan",
                        "tag": "trojan-in",
                        "listen": "::",
                        "listen_port": parseInt(server.port),
                        "users": [
                            {
                                "name": "user",
                                "password": server.password
                            }
                        ],
                        "tls": {
                            "enabled": true,
                            "server_name": server.domain,
                            "alpn": ["h2", "http/1.1"],
                            "certificate_path": `/etc/letsencrypt/live/${server.domain}/fullchain.pem`,
                            "key_path": `/etc/letsencrypt/live/${server.domain}/privkey.pem`
                        },
                        "fallback": {
                            "server": "127.0.0.1",
                            "server_port": 80
                        },
                        "multiplex": {
                            "enabled": true,
                            "padding": false
                        }
                    }
                ],
                "outbounds": [
                    {
                        "type": "direct",
                        "tag": "direct"
                    }
                ]
            };
        }

        // ç”Ÿæˆå®¢æˆ·ç«¯é…ç½®
        function generateClientConfig(servers, apiSecret) {
            const outbounds = [
                {
                    "type": "selector",
                    "tag": "proxy",
                    "outbounds": ["auto", ...servers.map(s => s.name), "direct"],
                    "default": "auto"
                },
                {
                    "type": "urltest",
                    "tag": "auto",
                    "outbounds": servers.map(s => s.name),
                    "url": "https://www.gstatic.com/generate_204",
                    "interval": "3m",
                    "tolerance": 50
                }
            ];
            
            servers.forEach(server => {
                outbounds.push({
                    "type": "trojan",
                    "tag": server.name,
                    "server": server.domain,
                    "server_port": parseInt(server.port),
                    "password": server.password,
                    "tls": {
                        "enabled": true,
                        "server_name": server.domain,
                        "insecure": false
                    },
                    "multiplex": {
                        "enabled": true,
                        "protocol": "h2mux",
                        "max_connections": 4,
                        "min_streams": 4,
                        "padding": false
                    }
                });
            });
            
            outbounds.push(
                {
                    "type": "direct",
                    "tag": "direct"
                },
                {
                    "type": "block",
                    "tag": "block"
                }
            );
            
            return {
                "log": {
                    "level": "info",
                    "timestamp": true
                },
                "dns": {
                    "servers": [
                        {
                            "tag": "google",
                            "address": "tls://8.8.8.8",
                            "detour": "proxy"
                        },
                        {
                            "tag": "local",
                            "address": "223.5.5.5",
                            "detour": "direct"
                        }
                    ],
                    "rules": [
                        {
                            "geosite": "cn",
                            "server": "local"
                        }
                    ],
                    "final": "google"
                },
                "inbounds": [
                    {
                        "type": "tun",
                        "tag": "tun-in",
                        "inet4_address": "172.19.0.1/30",
                        "auto_route": true,
                        "strict_route": true,
                        "sniff": true,
                        "sniff_override_destination": true,
                        "stack": "system"
                    }
                ],
                "outbounds": outbounds,
                "route": {
                    "rules": [
                        {
                            "protocol": "dns",
                            "action": "hijack-dns"
                        },
                        {
                            "geosite": "category-ads-all",
                            "action": "reject"
                        },
                        {
                            "geoip": "private",
                            "outbound": "direct"
                        },
                        {
                            "geosite": "cn",
                            "geoip": "cn",
                            "outbound": "direct"
                        }
                    ],
                    "final": "proxy",
                    "auto_detect_interface": true
                },
                "experimental": {
                    "clash_api": {
                        "external_controller": "127.0.0.1:9090",
                        "external_ui": "ui",
                        "external_ui_download_url": "https://github.com/MetaCubeX/Yacd-meta/archive/gh-pages.zip",
                        "external_ui_download_detour": "proxy",
                        "secret": apiSecret,
                        "default_mode": "rule",
                        "access_control_allow_origin": [],
                        "access_control_allow_private_network": false
                    },
                    "cache_file": {
                        "enabled": true,
                        "path": "cache.db",
                        "cache_id": "",
                        "store_fakeip": true,
                        "store_rdrc": true,
                        "rdrc_timeout": "7d"
                    }
                }
            };
        }

        // ç”Ÿæˆæ‰€æœ‰é…ç½®
        function generateAllConfigs() {
            const servers = collectServerData();
            
            if (servers.length === 0) {
                alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªæœåŠ¡å™¨å¹¶å¡«å†™åŸŸåï¼');
                return;
            }
            
            const subscriptionKey = document.getElementById('subscriptionKey').value || generateRandomString(32);
            const apiSecret = document.getElementById('apiSecret').value || generateRandomString(32);
            
            let output = '========== é…ç½®ä¿¡æ¯ ==========\n\n';
            output += 'è®¢é˜…å¯†é’¥: ' + subscriptionKey + '\n';
            output += 'APIå¯†é’¥: ' + apiSecret + '\n\n';
            
            // ç”ŸæˆæœåŠ¡å™¨é…ç½®
            servers.forEach((server, index) => {
                output += `========== æœåŠ¡å™¨ ${index + 1}: ${server.name} ==========\n\n`;
                output += 'åŸŸå: ' + server.domain + '\n';
                output += 'ç«¯å£: ' + server.port + '\n';
                output += 'å¯†ç : ' + server.password + '\n';
                output += 'é‚®ç®±: ' + server.email + '\n\n';
                output += '--- æœåŠ¡å™¨é…ç½® (config.json) ---\n';
                output += JSON.stringify(generateServerConfig(server), null, 2) + '\n\n';
            });
            
            // ç”Ÿæˆå®¢æˆ·ç«¯é…ç½®
            output += '========== å®¢æˆ·ç«¯é…ç½® ==========\n\n';
            output += JSON.stringify(generateClientConfig(servers, apiSecret), null, 2) + '\n\n';
            
            // æ˜¾ç¤ºè¾“å‡º
            currentConfig = output;
            document.getElementById('config-output').textContent = output;
            document.getElementById('output-section').style.display = 'block';
            document.getElementById('output-section').scrollIntoView({ behavior: 'smooth' });
        }

        // å¤åˆ¶é…ç½®
        function copyConfig() {
            if (!currentConfig) {
                alert('è¯·å…ˆç”Ÿæˆé…ç½®ï¼');
                return;
            }
            
            navigator.clipboard.writeText(currentConfig).then(() => {
                const btn = document.getElementById('copyBtn');
                const originalText = btn.textContent;
                btn.textContent = 'âœ… å·²å¤åˆ¶';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            }).catch(err => {
                // é™çº§æ–¹æ¡ˆ
                const textarea = document.createElement('textarea');
                textarea.value = currentConfig;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('é…ç½®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            });
        }

        // ä¸‹è½½é…ç½®
        function downloadConfig() {
            if (!currentConfig) {
                alert('è¯·å…ˆç”Ÿæˆé…ç½®ï¼');
                return;
            }
            
            const blob = new Blob([currentConfig], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sing-box-config-' + Date.now() + '.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', function() {
            // ç”Ÿæˆåˆå§‹å¯†é’¥
            document.getElementById('subscriptionKey').value = generatePassword(32);
            document.getElementById('apiSecret').value = generatePassword(32);
            
            // æ·»åŠ ä¸¤ä¸ªé»˜è®¤æœåŠ¡å™¨
            addServer();
            addServer();
            
            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            document.getElementById('genSubKey').addEventListener('click', function() {
                document.getElementById('subscriptionKey').value = generatePassword(32);
            });
            
            document.getElementById('genApiKey').addEventListener('click', function() {
                document.getElementById('apiSecret').value = generatePassword(32);
            });
            
            document.getElementById('addServerBtn').addEventListener('click', addServer);
            
            document.getElementById('generateBtn').addEventListener('click', generateAllConfigs);
            
            document.getElementById('copyBtn').addEventListener('click', copyConfig);
            
            document.getElementById('downloadBtn').addEventListener('click', downloadConfig);
        });
    </script>
</body>
</html>