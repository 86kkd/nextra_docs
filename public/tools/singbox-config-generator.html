<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sing-box Trojan 配置生成器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        input[type="text"],
        input[type="number"],
        input[type="email"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .password-group {
            display: flex;
            gap: 10px;
        }

        .password-input {
            flex: 1;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }

        .server-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }

        .server-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .server-title {
            font-size: 1.2em;
            color: #333;
            font-weight: 600;
        }

        .remove-server {
            background: #ff4757;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .output-section {
            margin-top: 30px;
        }

        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            background: #f5f5f5;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .config-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.5;
            overflow-x: auto;
            position: relative;
            max-height: 600px;
            overflow-y: auto;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .copy-btn:hover {
            background: #764ba2;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #1976d2;
        }

        .alert-success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #2e7d32;
        }

        .password-strength {
            margin-top: 5px;
            font-size: 12px;
        }

        .strength-weak {
            color: #f44336;
        }

        .strength-medium {
            color: #ff9800;
        }

        .strength-strong {
            color: #4caf50;
        }

        .download-section {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 sing-box Trojan 配置生成器</h1>
        
        <div class="card">
            <div class="alert alert-info">
                💡 这个工具帮助你快速生成 sing-box 的 Trojan 节点配置，自动生成强密码，并导出完整的配置文件。
            </div>
            
            <h2 class="section-title">基础设置</h2>
            
            <div class="form-group">
                <label for="subscriptionKey">订阅密钥（用于保护订阅链接）</label>
                <div class="password-group">
                    <input type="text" id="subscriptionKey" class="password-input" placeholder="留空将自动生成">
                    <button class="btn btn-secondary" onclick="generatePassword('subscriptionKey')">生成密钥</button>
                </div>
            </div>

            <div class="form-group">
                <label for="apiSecret">API 密钥（用于 Web UI）</label>
                <div class="password-group">
                    <input type="text" id="apiSecret" class="password-input" placeholder="留空将自动生成">
                    <button class="btn btn-secondary" onclick="generatePassword('apiSecret')">生成密钥</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h2 class="section-title">服务器配置</h2>
            
            <div id="servers-container">
                <!-- 服务器配置将动态添加到这里 -->
            </div>
            
            <button class="btn btn-primary" onclick="addServer()">+ 添加服务器</button>
        </div>

        <div class="card">
            <h2 class="section-title">生成配置</h2>
            
            <div class="form-group">
                <label>选择要生成的配置：</label>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="genServerConfig" checked style="margin-right: 8px;">
                        服务器配置
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="genClientConfig" checked style="margin-right: 8px;">
                        客户端配置
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="genWorkerConfig" checked style="margin-right: 8px;">
                        Cloudflare Worker
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="genDockerCompose" checked style="margin-right: 8px;">
                        Docker Compose
                    </label>
                </div>
            </div>
            
            <button class="btn btn-success" onclick="generateAllConfigs()" style="width: 100%; font-size: 18px;">
                🎯 生成所有配置
            </button>
        </div>

        <div class="card output-section" id="output-section" style="display: none;">
            <h2 class="section-title">生成的配置文件</h2>
            
            <div class="tab-container" id="tabs">
                <!-- 标签页将动态添加 -->
            </div>
            
            <div id="config-outputs">
                <!-- 配置输出将动态添加 -->
            </div>
            
            <div class="download-section">
                <button class="btn btn-primary" onclick="downloadAllConfigs()">📦 下载所有配置（ZIP）</button>
                <button class="btn btn-secondary" onclick="copyCurrentConfig()">📋 复制当前配置</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        let serverCount = 0;
        let currentTab = '';
        let generatedConfigs = {};

        // 初始化
        window.onload = function() {
            // 自动生成初始密钥
            generatePassword('subscriptionKey');
            generatePassword('apiSecret');
            // 添加两个默认服务器
            addServer();
            addServer();
        };

        // 生成强密码
        function generatePassword(inputId, length = 32) {
            const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*';
            let password = '';
            for (let i = 0; i < length; i++) {
                password += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            document.getElementById(inputId).value = password;
            
            // 如果是服务器密码，检查强度
            if (inputId.includes('password')) {
                checkPasswordStrength(inputId);
            }
        }

        // 生成 Trojan 密码（不含特殊字符，避免配置问题）
        function generateTrojanPassword(inputId) {
            const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let password = '';
            for (let i = 0; i < 16; i++) {
                password += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            document.getElementById(inputId).value = password;
            checkPasswordStrength(inputId);
        }

        // 检查密码强度
        function checkPasswordStrength(inputId) {
            const password = document.getElementById(inputId).value;
            const strengthId = inputId + '-strength';
            let strengthElement = document.getElementById(strengthId);
            
            if (!strengthElement) {
                strengthElement = document.createElement('div');
                strengthElement.id = strengthId;
                strengthElement.className = 'password-strength';
                document.getElementById(inputId).parentElement.appendChild(strengthElement);
            }
            
            let strength = 0;
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^a-zA-Z0-9]/.test(password)) strength++;
            
            if (strength < 2) {
                strengthElement.className = 'password-strength strength-weak';
                strengthElement.textContent = '⚠️ 密码强度：弱';
            } else if (strength < 4) {
                strengthElement.className = 'password-strength strength-medium';
                strengthElement.textContent = '⚡ 密码强度：中';
            } else {
                strengthElement.className = 'password-strength strength-strong';
                strengthElement.textContent = '✅ 密码强度：强';
            }
        }

        // 添加服务器
        function addServer() {
            serverCount++;
            const container = document.getElementById('servers-container');
            const serverDiv = document.createElement('div');
            serverDiv.className = 'server-card';
            serverDiv.id = `server-${serverCount}`;
            
            const locations = ['香港', '美国', '日本', '新加坡', '韩国', '台湾'];
            const defaultLocation = locations[(serverCount - 1) % locations.length];
            
            serverDiv.innerHTML = `
                <div class="server-header">
                    <div class="server-title">服务器 ${serverCount} - ${defaultLocation}</div>
                    ${serverCount > 1 ? '<button class="remove-server" onclick="removeServer(' + serverCount + ')">删除</button>' : ''}
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label for="server-name-${serverCount}">节点名称</label>
                        <input type="text" id="server-name-${serverCount}" value="${defaultLocation}-${serverCount}" placeholder="例如：香港-HK">
                    </div>
                    <div class="form-group">
                        <label for="server-domain-${serverCount}">服务器域名</label>
                        <input type="text" id="server-domain-${serverCount}" placeholder="例如：hk.example.com">
                    </div>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label for="server-ip-${serverCount}">服务器 IP（可选）</label>
                        <input type="text" id="server-ip-${serverCount}" placeholder="例如：1.2.3.4">
                    </div>
                    <div class="form-group">
                        <label for="server-port-${serverCount}">端口</label>
                        <input type="number" id="server-port-${serverCount}" value="443" placeholder="443">
                    </div>
                </div>
                <div class="form-group">
                    <label for="server-password-${serverCount}">Trojan 密码</label>
                    <div class="password-group">
                        <input type="text" id="server-password-${serverCount}" class="password-input" placeholder="留空将自动生成">
                        <button class="btn btn-secondary" onclick="generateTrojanPassword('server-password-${serverCount}')">生成密码</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="server-email-${serverCount}">证书邮箱（Let's Encrypt）</label>
                    <input type="email" id="server-email-${serverCount}" placeholder="your@email.com">
                </div>
            `;
            
            container.appendChild(serverDiv);
            
            // 自动生成密码
            generateTrojanPassword(`server-password-${serverCount}`);
        }

        // 删除服务器
        function removeServer(id) {
            const element = document.getElementById(`server-${id}`);
            if (element) {
                element.remove();
            }
        }

        // 生成所有配置
        function generateAllConfigs() {
            generatedConfigs = {};
            const servers = collectServerData();
            
            if (servers.length === 0) {
                alert('请至少添加一个服务器！');
                return;
            }
            
            // 检查必填字段
            for (let server of servers) {
                if (!server.domain) {
                    alert(`服务器 "${server.name}" 的域名不能为空！`);
                    return;
                }
            }
            
            const subscriptionKey = document.getElementById('subscriptionKey').value || generateRandomString(32);
            const apiSecret = document.getElementById('apiSecret').value || generateRandomString(32);
            
            // 生成各种配置
            if (document.getElementById('genServerConfig').checked) {
                servers.forEach((server, index) => {
                    generatedConfigs[`server-${index + 1}-config.json`] = generateServerConfig(server);
                    generatedConfigs[`server-${index + 1}-install.sh`] = generateInstallScript(server);
                });
            }
            
            if (document.getElementById('genClientConfig').checked) {
                generatedConfigs['client-config.json'] = generateClientConfig(servers, apiSecret);
            }
            
            if (document.getElementById('genWorkerConfig').checked) {
                generatedConfigs['cloudflare-worker.js'] = generateWorkerScript(servers, subscriptionKey, apiSecret);
            }
            
            if (document.getElementById('genDockerCompose').checked) {
                servers.forEach((server, index) => {
                    generatedConfigs[`server-${index + 1}-docker-compose.yml`] = generateDockerCompose(server);
                });
            }
            
            // 显示输出
            displayConfigs();
        }

        // 收集服务器数据
        function collectServerData() {
            const servers = [];
            for (let i = 1; i <= serverCount; i++) {
                const serverElement = document.getElementById(`server-${i}`);
                if (!serverElement) continue;
                
                servers.push({
                    name: document.getElementById(`server-name-${i}`).value || `服务器-${i}`,
                    domain: document.getElementById(`server-domain-${i}`).value,
                    ip: document.getElementById(`server-ip-${i}`).value,
                    port: document.getElementById(`server-port-${i}`).value || '443',
                    password: document.getElementById(`server-password-${i}`).value || generateRandomString(16),
                    email: document.getElementById(`server-email-${i}`).value || 'admin@example.com'
                });
            }
            return servers;
        }

        // 生成服务器配置
        function generateServerConfig(server) {
            return JSON.stringify({
                "log": {
                    "level": "info",
                    "timestamp": true
                },
                "inbounds": [
                    {
                        "type": "trojan",
                        "tag": "trojan-in",
                        "listen": "::",
                        "listen_port": parseInt(server.port),
                        "users": [
                            {
                                "name": "user",
                                "password": server.password
                            }
                        ],
                        "tls": {
                            "enabled": true,
                            "server_name": server.domain,
                            "alpn": ["h2", "http/1.1"],
                            "certificate_path": `/etc/letsencrypt/live/${server.domain}/fullchain.pem`,
                            "key_path": `/etc/letsencrypt/live/${server.domain}/privkey.pem`
                        },
                        "fallback": {
                            "server": "127.0.0.1",
                            "server_port": 80
                        },
                        "multiplex": {
                            "enabled": true,
                            "padding": false,
                            "brutal": {
                                "enabled": true,
                                "up_mbps": 100,
                                "down_mbps": 100
                            }
                        }
                    }
                ],
                "outbounds": [
                    {
                        "type": "direct",
                        "tag": "direct"
                    }
                ]
            }, null, 2);
        }

        // 生成安装脚本
        function generateInstallScript(server) {
            return `#!/bin/bash
# sing-box Trojan 服务器自动安装脚本
# 服务器: ${server.name} (${server.domain})

set -e

# 颜色输出
RED='\\033[0;31m'
GREEN='\\033[0;32m'
YELLOW='\\033[1;33m'
NC='\\033[0m'

echo -e "\${GREEN}开始安装 sing-box Trojan 服务器...\${NC}"

# 1. 更新系统
echo -e "\${YELLOW}更新系统...\${NC}"
apt update && apt upgrade -y
apt install -y curl wget certbot nginx

# 2. 安装 sing-box
echo -e "\${YELLOW}安装 sing-box...\${NC}"
bash <(curl -fsSL https://sing-box.app/deb-install.sh)

# 3. 申请证书
echo -e "\${YELLOW}申请 SSL 证书...\${NC}"
certbot certonly --standalone \\
  -d ${server.domain} \\
  --email ${server.email} \\
  --agree-tos \\
  --non-interactive

# 4. 创建配置文件
echo -e "\${YELLOW}创建配置文件...\${NC}"
mkdir -p /etc/sing-box

cat > /etc/sing-box/config.json << 'EOF'
${generateServerConfig(server)}
EOF

# 5. 配置 Nginx 伪装站点
cat > /etc/nginx/sites-available/default << 'EOF'
server {
    listen 127.0.0.1:80;
    server_name _;
    location / {
        return 200 "Welcome to nginx!";
        add_header Content-Type text/plain;
    }
}
EOF

systemctl restart nginx

# 6. 创建 systemd 服务
cat > /etc/systemd/system/sing-box.service << 'EOF'
[Unit]
Description=sing-box service
After=network.target nss-lookup.target

[Service]
CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW
ExecStart=/usr/bin/sing-box run -c /etc/sing-box/config.json
Restart=on-failure
RestartSec=10
LimitNOFILE=infinity

[Install]
WantedBy=multi-user.target
EOF

# 7. 启动服务
echo -e "\${YELLOW}启动服务...\${NC}"
systemctl daemon-reload
systemctl enable sing-box
systemctl start sing-box

# 8. 配置防火墙
echo -e "\${YELLOW}配置防火墙...\${NC}"
ufw allow 22/tcp
ufw allow 80/tcp
ufw allow ${server.port}/tcp
ufw --force enable

# 9. 设置自动续期
echo -e "\${YELLOW}设置证书自动续期...\${NC}"
(crontab -l 2>/dev/null; echo "30 2 * * * certbot renew --quiet --post-hook 'systemctl reload sing-box'") | crontab -

# 10. 输出信息
echo -e "\${GREEN}========================================\${NC}"
echo -e "\${GREEN}安装完成！\${NC}"
echo -e "\${GREEN}========================================\${NC}"
echo -e "节点名称: \${YELLOW}${server.name}\${NC}"
echo -e "服务器域名: \${YELLOW}${server.domain}\${NC}"
echo -e "端口: \${YELLOW}${server.port}\${NC}"
echo -e "密码: \${YELLOW}${server.password}\${NC}"
echo -e "\${GREEN}========================================\${NC}"

# 检查服务状态
systemctl status sing-box --no-pager`;
        }

        // 生成客户端配置
        function generateClientConfig(servers, apiSecret) {
            const outbounds = [
                {
                    "type": "selector",
                    "tag": "proxy",
                    "outbounds": ["auto", ...servers.map(s => s.name), "direct"],
                    "default": "auto"
                },
                {
                    "type": "urltest",
                    "tag": "auto",
                    "outbounds": servers.map(s => s.name),
                    "url": "https://www.gstatic.com/generate_204",
                    "interval": "3m",
                    "tolerance": 50
                }
            ];
            
            // 添加每个服务器的出站配置
            servers.forEach(server => {
                outbounds.push({
                    "type": "trojan",
                    "tag": server.name,
                    "server": server.domain,
                    "server_port": parseInt(server.port),
                    "password": server.password,
                    "tls": {
                        "enabled": true,
                        "server_name": server.domain,
                        "insecure": false
                    },
                    "multiplex": {
                        "enabled": true,
                        "protocol": "h2mux",
                        "max_connections": 4,
                        "min_streams": 4,
                        "padding": false
                    }
                });
            });
            
            outbounds.push(
                {
                    "type": "direct",
                    "tag": "direct"
                },
                {
                    "type": "block",
                    "tag": "block"
                }
            );
            
            return JSON.stringify({
                "log": {
                    "level": "info",
                    "timestamp": true
                },
                "dns": {
                    "servers": [
                        {
                            "tag": "google",
                            "address": "tls://8.8.8.8",
                            "detour": "proxy"
                        },
                        {
                            "tag": "local",
                            "address": "223.5.5.5",
                            "detour": "direct"
                        }
                    ],
                    "rules": [
                        {
                            "geosite": "cn",
                            "server": "local"
                        }
                    ],
                    "final": "google"
                },
                "inbounds": [
                    {
                        "type": "tun",
                        "tag": "tun-in",
                        "inet4_address": "172.19.0.1/30",
                        "inet6_address": "fdfe:dcba:9876::1/126",
                        "auto_route": true,
                        "strict_route": true,
                        "sniff": true,
                        "sniff_override_destination": true,
                        "stack": "system"
                    }
                ],
                "outbounds": outbounds,
                "route": {
                    "rules": [
                        {
                            "protocol": "dns",
                            "action": "hijack-dns"
                        },
                        {
                            "geosite": "category-ads-all",
                            "action": "reject"
                        },
                        {
                            "geoip": "private",
                            "outbound": "direct"
                        },
                        {
                            "geosite": "cn",
                            "geoip": "cn",
                            "outbound": "direct"
                        }
                    ],
                    "final": "proxy",
                    "auto_detect_interface": true
                },
                "experimental": {
                    "clash_api": {
                        "external_controller": "127.0.0.1:9090",
                        "external_ui": "ui",
                        "external_ui_download_url": "https://github.com/MetaCubeX/Yacd-meta/archive/gh-pages.zip",
                        "secret": apiSecret,
                        "default_mode": "rule"
                    }
                }
            }, null, 2);
        }

        // 生成 Worker 脚本
        function generateWorkerScript(servers, subscriptionKey, apiSecret) {
            const clientConfig = JSON.parse(generateClientConfig(servers, apiSecret));
            
            return `// Cloudflare Worker 订阅服务
// 自动生成的配置，包含 ${servers.length} 个服务器

addEventListener('fetch', event => {
    event.respondWith(handleRequest(event.request))
})

async function handleRequest(request) {
    const url = new URL(request.url)
    
    // 验证密钥
    const AUTH_KEY = '${subscriptionKey}'
    if (url.searchParams.get('key') !== AUTH_KEY) {
        return new Response('Unauthorized', { status: 401 })
    }
    
    // sing-box 客户端配置
    const config = ${JSON.stringify(clientConfig, null, 4).split('\n').map((line, i) => i === 0 ? line : '    ' + line).join('\n')}
    
    return new Response(JSON.stringify(config, null, 2), {
        headers: {
            'Content-Type': 'application/json',
            'Cache-Control': 'no-cache',
            'Access-Control-Allow-Origin': '*'
        }
    })
}`;
        }

        // 生成 Docker Compose
        function generateDockerCompose(server) {
            return `version: '3.8'

services:
  sing-box:
    image: ghcr.io/sagernet/sing-box:latest
    container_name: sing-box-${server.name.toLowerCase().replace(/[^a-z0-9]/g, '-')}
    restart: unless-stopped
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - ./config.json:/etc/sing-box/config.json:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - ./data:/var/lib/sing-box
    environment:
      - TZ=Asia/Shanghai
    command: run -c /etc/sing-box/config.json

  # Nginx 伪装站点
  nginx:
    image: nginx:alpine
    container_name: nginx-fallback
    restart: unless-stopped
    ports:
      - "127.0.0.1:80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./html:/usr/share/nginx/html:ro

  # 证书自动续期
  certbot:
    image: certbot/certbot
    container_name: certbot
    volumes:
      - /etc/letsencrypt:/etc/letsencrypt
      - ./certbot:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
`;
        }

        // 显示配置
        function displayConfigs() {
            const outputSection = document.getElementById('output-section');
            outputSection.style.display = 'block';
            
            const tabsContainer = document.getElementById('tabs');
            const outputsContainer = document.getElementById('config-outputs');
            
            tabsContainer.innerHTML = '';
            outputsContainer.innerHTML = '';
            
            let isFirst = true;
            for (const [filename, content] of Object.entries(generatedConfigs)) {
                // 创建标签
                const tab = document.createElement('button');
                tab.className = `tab ${isFirst ? 'active' : ''}`;
                tab.textContent = filename;
                tab.onclick = () => switchTab(filename);
                tabsContainer.appendChild(tab);
                
                // 创建输出区域
                const outputDiv = document.createElement('div');
                outputDiv.id = `output-${filename}`;
                outputDiv.style.display = isFirst ? 'block' : 'none';
                outputDiv.innerHTML = `
                    <div class="config-output">
                        <button class="copy-btn" onclick="copyConfig('${filename}')">复制</button>
                        <pre><code>${escapeHtml(content)}</code></pre>
                    </div>
                `;
                outputsContainer.appendChild(outputDiv);
                
                if (isFirst) {
                    currentTab = filename;
                    isFirst = false;
                }
            }
            
            // 滚动到输出区域
            outputSection.scrollIntoView({ behavior: 'smooth' });
        }

        // 切换标签
        function switchTab(filename) {
            // 更新标签状态
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.textContent === filename) {
                    tab.classList.add('active');
                }
            });
            
            // 更新显示内容
            document.querySelectorAll('[id^="output-"]').forEach(div => {
                div.style.display = 'none';
            });
            document.getElementById(`output-${filename}`).style.display = 'block';
            currentTab = filename;
        }

        // 复制配置
        function copyConfig(filename) {
            const content = generatedConfigs[filename];
            navigator.clipboard.writeText(content).then(() => {
                // 显示复制成功提示
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '✅ 已复制';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }

        // 复制当前配置
        function copyCurrentConfig() {
            if (currentTab) {
                copyConfig(currentTab);
            }
        }

        // 下载所有配置
        function downloadAllConfigs() {
            const zip = new JSZip();
            const servers = collectServerData();
            
            // 添加所有配置文件到 ZIP
            for (const [filename, content] of Object.entries(generatedConfigs)) {
                // 根据文件类型组织目录
                if (filename.includes('server-')) {
                    const serverNum = filename.match(/server-(\d+)/)[1];
                    zip.folder(`server-${serverNum}`).file(filename.replace(/^server-\d+-/, ''), content);
                } else if (filename.includes('client')) {
                    zip.folder('client').file(filename, content);
                } else if (filename.includes('worker')) {
                    zip.folder('cloudflare').file(filename, content);
                } else if (filename.includes('docker')) {
                    const serverNum = filename.match(/server-(\d+)/)?.[1];
                    if (serverNum) {
                        zip.folder(`server-${serverNum}`).file('docker-compose.yml', content);
                    }
                }
            }
            
            // 添加 README
            const readme = `# sing-box Trojan 配置文件

生成时间: ${new Date().toLocaleString()}

## 服务器列表
${servers.map((s, i) => `- 服务器 ${i + 1}: ${s.name} (${s.domain})`).join('\n')}

## 订阅地址
https://your-worker.workers.dev/?key=${document.getElementById('subscriptionKey').value}

## Web UI
http://127.0.0.1:9090/ui
API Secret: ${document.getElementById('apiSecret').value}

## 使用说明

### 服务器部署
1. 将 server-X 文件夹中的 install.sh 上传到服务器
2. 执行: chmod +x install.sh && ./install.sh
3. 或使用 Docker Compose 部署

### 客户端使用
1. 使用 client/client-config.json 配置文件
2. 或通过订阅链接导入

### Cloudflare Worker
1. 登录 Cloudflare Dashboard
2. 创建新的 Worker
3. 粘贴 cloudflare/cloudflare-worker.js 内容
4. 部署

## 安全提醒
- 请妥善保管密码和密钥
- 定期更新证书和软件版本
- 监控服务器状态和日志
`;
            zip.file('README.md', readme);
            
            // 生成并下载 ZIP
            zip.generateAsync({ type: 'blob' }).then(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sing-box-config-${new Date().getTime()}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
        }

        // 辅助函数
        function generateRandomString(length) {
            const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            return result;
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>