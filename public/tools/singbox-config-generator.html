<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sing-box Trojan é…ç½®ç”Ÿæˆå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        input[type="text"],
        input[type="number"],
        input[type="email"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .password-group {
            display: flex;
            gap: 10px;
        }

        .password-input {
            flex: 1;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }

        .server-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }

        .server-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .server-title {
            font-size: 1.2em;
            color: #333;
            font-weight: 600;
        }

        .remove-server {
            background: #ff4757;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .output-section {
            margin-top: 30px;
        }

        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            background: #f5f5f5;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .config-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.5;
            overflow-x: auto;
            position: relative;
            max-height: 600px;
            overflow-y: auto;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .copy-btn:hover {
            background: #764ba2;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #1976d2;
        }

        .alert-success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #2e7d32;
        }

        .password-strength {
            margin-top: 5px;
            font-size: 12px;
        }

        .strength-weak {
            color: #f44336;
        }

        .strength-medium {
            color: #ff9800;
        }

        .strength-strong {
            color: #4caf50;
        }

        .download-section {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ sing-box Trojan é…ç½®ç”Ÿæˆå™¨</h1>
        
        <div class="card">
            <div class="alert alert-info">
                ğŸ’¡ è¿™ä¸ªå·¥å…·å¸®åŠ©ä½ å¿«é€Ÿç”Ÿæˆ sing-box çš„ Trojan èŠ‚ç‚¹é…ç½®ï¼Œè‡ªåŠ¨ç”Ÿæˆå¼ºå¯†ç ï¼Œå¹¶å¯¼å‡ºå®Œæ•´çš„é…ç½®æ–‡ä»¶ã€‚
            </div>
            
            <h2 class="section-title">åŸºç¡€è®¾ç½®</h2>
            
            <div class="form-group">
                <label for="subscriptionKey">è®¢é˜…å¯†é’¥ï¼ˆç”¨äºä¿æŠ¤è®¢é˜…é“¾æ¥ï¼‰</label>
                <div class="password-group">
                    <input type="text" id="subscriptionKey" class="password-input" placeholder="ç•™ç©ºå°†è‡ªåŠ¨ç”Ÿæˆ">
                    <button class="btn btn-secondary" onclick="generatePassword('subscriptionKey')">ç”Ÿæˆå¯†é’¥</button>
                </div>
            </div>

            <div class="form-group">
                <label for="apiSecret">API å¯†é’¥ï¼ˆç”¨äº Web UIï¼‰</label>
                <div class="password-group">
                    <input type="text" id="apiSecret" class="password-input" placeholder="ç•™ç©ºå°†è‡ªåŠ¨ç”Ÿæˆ">
                    <button class="btn btn-secondary" onclick="generatePassword('apiSecret')">ç”Ÿæˆå¯†é’¥</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h2 class="section-title">æœåŠ¡å™¨é…ç½®</h2>
            
            <div id="servers-container">
                <!-- æœåŠ¡å™¨é…ç½®å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
            </div>
            
            <button class="btn btn-primary" onclick="addServer()">+ æ·»åŠ æœåŠ¡å™¨</button>
        </div>

        <div class="card">
            <h2 class="section-title">ç”Ÿæˆé…ç½®</h2>
            
            <div class="form-group">
                <label>é€‰æ‹©è¦ç”Ÿæˆçš„é…ç½®ï¼š</label>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="genServerConfig" checked style="margin-right: 8px;">
                        æœåŠ¡å™¨é…ç½®
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="genClientConfig" checked style="margin-right: 8px;">
                        å®¢æˆ·ç«¯é…ç½®
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="genWorkerConfig" checked style="margin-right: 8px;">
                        Cloudflare Worker
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="genDockerCompose" checked style="margin-right: 8px;">
                        Docker Compose
                    </label>
                </div>
            </div>
            
            <button class="btn btn-success" onclick="generateAllConfigs()" style="width: 100%; font-size: 18px;">
                ğŸ¯ ç”Ÿæˆæ‰€æœ‰é…ç½®
            </button>
        </div>

        <div class="card output-section" id="output-section" style="display: none;">
            <h2 class="section-title">ç”Ÿæˆçš„é…ç½®æ–‡ä»¶</h2>
            
            <div class="tab-container" id="tabs">
                <!-- æ ‡ç­¾é¡µå°†åŠ¨æ€æ·»åŠ  -->
            </div>
            
            <div id="config-outputs">
                <!-- é…ç½®è¾“å‡ºå°†åŠ¨æ€æ·»åŠ  -->
            </div>
            
            <div class="download-section">
                <button class="btn btn-primary" onclick="downloadAllConfigs()">ğŸ“¦ ä¸‹è½½æ‰€æœ‰é…ç½®ï¼ˆZIPï¼‰</button>
                <button class="btn btn-secondary" onclick="copyCurrentConfig()">ğŸ“‹ å¤åˆ¶å½“å‰é…ç½®</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        let serverCount = 0;
        let currentTab = '';
        let generatedConfigs = {};

        // åˆå§‹åŒ–
        window.onload = function() {
            // è‡ªåŠ¨ç”Ÿæˆåˆå§‹å¯†é’¥
            generatePassword('subscriptionKey');
            generatePassword('apiSecret');
            // æ·»åŠ ä¸¤ä¸ªé»˜è®¤æœåŠ¡å™¨
            addServer();
            addServer();
        };

        // ç”Ÿæˆå¼ºå¯†ç 
        function generatePassword(inputId, length = 32) {
            const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*';
            let password = '';
            for (let i = 0; i < length; i++) {
                password += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            document.getElementById(inputId).value = password;
            
            // å¦‚æœæ˜¯æœåŠ¡å™¨å¯†ç ï¼Œæ£€æŸ¥å¼ºåº¦
            if (inputId.includes('password')) {
                checkPasswordStrength(inputId);
            }
        }

        // ç”Ÿæˆ Trojan å¯†ç ï¼ˆä¸å«ç‰¹æ®Šå­—ç¬¦ï¼Œé¿å…é…ç½®é—®é¢˜ï¼‰
        function generateTrojanPassword(inputId) {
            const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let password = '';
            for (let i = 0; i < 16; i++) {
                password += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            document.getElementById(inputId).value = password;
            checkPasswordStrength(inputId);
        }

        // æ£€æŸ¥å¯†ç å¼ºåº¦
        function checkPasswordStrength(inputId) {
            const password = document.getElementById(inputId).value;
            const strengthId = inputId + '-strength';
            let strengthElement = document.getElementById(strengthId);
            
            if (!strengthElement) {
                strengthElement = document.createElement('div');
                strengthElement.id = strengthId;
                strengthElement.className = 'password-strength';
                document.getElementById(inputId).parentElement.appendChild(strengthElement);
            }
            
            let strength = 0;
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^a-zA-Z0-9]/.test(password)) strength++;
            
            if (strength < 2) {
                strengthElement.className = 'password-strength strength-weak';
                strengthElement.textContent = 'âš ï¸ å¯†ç å¼ºåº¦ï¼šå¼±';
            } else if (strength < 4) {
                strengthElement.className = 'password-strength strength-medium';
                strengthElement.textContent = 'âš¡ å¯†ç å¼ºåº¦ï¼šä¸­';
            } else {
                strengthElement.className = 'password-strength strength-strong';
                strengthElement.textContent = 'âœ… å¯†ç å¼ºåº¦ï¼šå¼º';
            }
        }

        // æ·»åŠ æœåŠ¡å™¨
        function addServer() {
            serverCount++;
            const container = document.getElementById('servers-container');
            const serverDiv = document.createElement('div');
            serverDiv.className = 'server-card';
            serverDiv.id = `server-${serverCount}`;
            
            const locations = ['é¦™æ¸¯', 'ç¾å›½', 'æ—¥æœ¬', 'æ–°åŠ å¡', 'éŸ©å›½', 'å°æ¹¾'];
            const defaultLocation = locations[(serverCount - 1) % locations.length];
            
            serverDiv.innerHTML = `
                <div class="server-header">
                    <div class="server-title">æœåŠ¡å™¨ ${serverCount} - ${defaultLocation}</div>
                    ${serverCount > 1 ? '<button class="remove-server" onclick="removeServer(' + serverCount + ')">åˆ é™¤</button>' : ''}
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label for="server-name-${serverCount}">èŠ‚ç‚¹åç§°</label>
                        <input type="text" id="server-name-${serverCount}" value="${defaultLocation}-${serverCount}" placeholder="ä¾‹å¦‚ï¼šé¦™æ¸¯-HK">
                    </div>
                    <div class="form-group">
                        <label for="server-domain-${serverCount}">æœåŠ¡å™¨åŸŸå</label>
                        <input type="text" id="server-domain-${serverCount}" placeholder="ä¾‹å¦‚ï¼šhk.example.com">
                    </div>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label for="server-ip-${serverCount}">æœåŠ¡å™¨ IPï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" id="server-ip-${serverCount}" placeholder="ä¾‹å¦‚ï¼š1.2.3.4">
                    </div>
                    <div class="form-group">
                        <label for="server-port-${serverCount}">ç«¯å£</label>
                        <input type="number" id="server-port-${serverCount}" value="443" placeholder="443">
                    </div>
                </div>
                <div class="form-group">
                    <label for="server-password-${serverCount}">Trojan å¯†ç </label>
                    <div class="password-group">
                        <input type="text" id="server-password-${serverCount}" class="password-input" placeholder="ç•™ç©ºå°†è‡ªåŠ¨ç”Ÿæˆ">
                        <button class="btn btn-secondary" onclick="generateTrojanPassword('server-password-${serverCount}')">ç”Ÿæˆå¯†ç </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="server-email-${serverCount}">è¯ä¹¦é‚®ç®±ï¼ˆLet's Encryptï¼‰</label>
                    <input type="email" id="server-email-${serverCount}" placeholder="your@email.com">
                </div>
            `;
            
            container.appendChild(serverDiv);
            
            // è‡ªåŠ¨ç”Ÿæˆå¯†ç 
            generateTrojanPassword(`server-password-${serverCount}`);
        }

        // åˆ é™¤æœåŠ¡å™¨
        function removeServer(id) {
            const element = document.getElementById(`server-${id}`);
            if (element) {
                element.remove();
            }
        }

        // ç”Ÿæˆæ‰€æœ‰é…ç½®
        function generateAllConfigs() {
            generatedConfigs = {};
            const servers = collectServerData();
            
            if (servers.length === 0) {
                alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªæœåŠ¡å™¨ï¼');
                return;
            }
            
            // æ£€æŸ¥å¿…å¡«å­—æ®µ
            for (let server of servers) {
                if (!server.domain) {
                    alert(`æœåŠ¡å™¨ "${server.name}" çš„åŸŸåä¸èƒ½ä¸ºç©ºï¼`);
                    return;
                }
            }
            
            const subscriptionKey = document.getElementById('subscriptionKey').value || generateRandomString(32);
            const apiSecret = document.getElementById('apiSecret').value || generateRandomString(32);
            
            // ç”Ÿæˆå„ç§é…ç½®
            if (document.getElementById('genServerConfig').checked) {
                servers.forEach((server, index) => {
                    generatedConfigs[`server-${index + 1}-config.json`] = generateServerConfig(server);
                    generatedConfigs[`server-${index + 1}-install.sh`] = generateInstallScript(server);
                });
            }
            
            if (document.getElementById('genClientConfig').checked) {
                generatedConfigs['client-config.json'] = generateClientConfig(servers, apiSecret);
            }
            
            if (document.getElementById('genWorkerConfig').checked) {
                generatedConfigs['cloudflare-worker.js'] = generateWorkerScript(servers, subscriptionKey, apiSecret);
            }
            
            if (document.getElementById('genDockerCompose').checked) {
                servers.forEach((server, index) => {
                    generatedConfigs[`server-${index + 1}-docker-compose.yml`] = generateDockerCompose(server);
                });
            }
            
            // æ˜¾ç¤ºè¾“å‡º
            displayConfigs();
        }

        // æ”¶é›†æœåŠ¡å™¨æ•°æ®
        function collectServerData() {
            const servers = [];
            for (let i = 1; i <= serverCount; i++) {
                const serverElement = document.getElementById(`server-${i}`);
                if (!serverElement) continue;
                
                servers.push({
                    name: document.getElementById(`server-name-${i}`).value || `æœåŠ¡å™¨-${i}`,
                    domain: document.getElementById(`server-domain-${i}`).value,
                    ip: document.getElementById(`server-ip-${i}`).value,
                    port: document.getElementById(`server-port-${i}`).value || '443',
                    password: document.getElementById(`server-password-${i}`).value || generateRandomString(16),
                    email: document.getElementById(`server-email-${i}`).value || 'admin@example.com'
                });
            }
            return servers;
        }

        // ç”ŸæˆæœåŠ¡å™¨é…ç½®
        function generateServerConfig(server) {
            return JSON.stringify({
                "log": {
                    "level": "info",
                    "timestamp": true
                },
                "inbounds": [
                    {
                        "type": "trojan",
                        "tag": "trojan-in",
                        "listen": "::",
                        "listen_port": parseInt(server.port),
                        "users": [
                            {
                                "name": "user",
                                "password": server.password
                            }
                        ],
                        "tls": {
                            "enabled": true,
                            "server_name": server.domain,
                            "alpn": ["h2", "http/1.1"],
                            "certificate_path": `/etc/letsencrypt/live/${server.domain}/fullchain.pem`,
                            "key_path": `/etc/letsencrypt/live/${server.domain}/privkey.pem`
                        },
                        "fallback": {
                            "server": "127.0.0.1",
                            "server_port": 80
                        },
                        "multiplex": {
                            "enabled": true,
                            "padding": false,
                            "brutal": {
                                "enabled": true,
                                "up_mbps": 100,
                                "down_mbps": 100
                            }
                        }
                    }
                ],
                "outbounds": [
                    {
                        "type": "direct",
                        "tag": "direct"
                    }
                ]
            }, null, 2);
        }

        // ç”Ÿæˆå®‰è£…è„šæœ¬
        function generateInstallScript(server) {
            return `#!/bin/bash
# sing-box Trojan æœåŠ¡å™¨è‡ªåŠ¨å®‰è£…è„šæœ¬
# æœåŠ¡å™¨: ${server.name} (${server.domain})

set -e

# é¢œè‰²è¾“å‡º
RED='\\033[0;31m'
GREEN='\\033[0;32m'
YELLOW='\\033[1;33m'
NC='\\033[0m'

echo -e "\${GREEN}å¼€å§‹å®‰è£… sing-box Trojan æœåŠ¡å™¨...\${NC}"

# 1. æ›´æ–°ç³»ç»Ÿ
echo -e "\${YELLOW}æ›´æ–°ç³»ç»Ÿ...\${NC}"
apt update && apt upgrade -y
apt install -y curl wget certbot nginx

# 2. å®‰è£… sing-box
echo -e "\${YELLOW}å®‰è£… sing-box...\${NC}"
bash <(curl -fsSL https://sing-box.app/deb-install.sh)

# 3. ç”³è¯·è¯ä¹¦
echo -e "\${YELLOW}ç”³è¯· SSL è¯ä¹¦...\${NC}"
certbot certonly --standalone \\
  -d ${server.domain} \\
  --email ${server.email} \\
  --agree-tos \\
  --non-interactive

# 4. åˆ›å»ºé…ç½®æ–‡ä»¶
echo -e "\${YELLOW}åˆ›å»ºé…ç½®æ–‡ä»¶...\${NC}"
mkdir -p /etc/sing-box

cat > /etc/sing-box/config.json << 'EOF'
${generateServerConfig(server)}
EOF

# 5. é…ç½® Nginx ä¼ªè£…ç«™ç‚¹
cat > /etc/nginx/sites-available/default << 'EOF'
server {
    listen 127.0.0.1:80;
    server_name _;
    location / {
        return 200 "Welcome to nginx!";
        add_header Content-Type text/plain;
    }
}
EOF

systemctl restart nginx

# 6. åˆ›å»º systemd æœåŠ¡
cat > /etc/systemd/system/sing-box.service << 'EOF'
[Unit]
Description=sing-box service
After=network.target nss-lookup.target

[Service]
CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW
ExecStart=/usr/bin/sing-box run -c /etc/sing-box/config.json
Restart=on-failure
RestartSec=10
LimitNOFILE=infinity

[Install]
WantedBy=multi-user.target
EOF

# 7. å¯åŠ¨æœåŠ¡
echo -e "\${YELLOW}å¯åŠ¨æœåŠ¡...\${NC}"
systemctl daemon-reload
systemctl enable sing-box
systemctl start sing-box

# 8. é…ç½®é˜²ç«å¢™
echo -e "\${YELLOW}é…ç½®é˜²ç«å¢™...\${NC}"
ufw allow 22/tcp
ufw allow 80/tcp
ufw allow ${server.port}/tcp
ufw --force enable

# 9. è®¾ç½®è‡ªåŠ¨ç»­æœŸ
echo -e "\${YELLOW}è®¾ç½®è¯ä¹¦è‡ªåŠ¨ç»­æœŸ...\${NC}"
(crontab -l 2>/dev/null; echo "30 2 * * * certbot renew --quiet --post-hook 'systemctl reload sing-box'") | crontab -

# 10. è¾“å‡ºä¿¡æ¯
echo -e "\${GREEN}========================================\${NC}"
echo -e "\${GREEN}å®‰è£…å®Œæˆï¼\${NC}"
echo -e "\${GREEN}========================================\${NC}"
echo -e "èŠ‚ç‚¹åç§°: \${YELLOW}${server.name}\${NC}"
echo -e "æœåŠ¡å™¨åŸŸå: \${YELLOW}${server.domain}\${NC}"
echo -e "ç«¯å£: \${YELLOW}${server.port}\${NC}"
echo -e "å¯†ç : \${YELLOW}${server.password}\${NC}"
echo -e "\${GREEN}========================================\${NC}"

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
systemctl status sing-box --no-pager`;
        }

        // ç”Ÿæˆå®¢æˆ·ç«¯é…ç½®
        function generateClientConfig(servers, apiSecret) {
            const outbounds = [
                {
                    "type": "selector",
                    "tag": "proxy",
                    "outbounds": ["auto", ...servers.map(s => s.name), "direct"],
                    "default": "auto"
                },
                {
                    "type": "urltest",
                    "tag": "auto",
                    "outbounds": servers.map(s => s.name),
                    "url": "https://www.gstatic.com/generate_204",
                    "interval": "3m",
                    "tolerance": 50
                }
            ];
            
            // æ·»åŠ æ¯ä¸ªæœåŠ¡å™¨çš„å‡ºç«™é…ç½®
            servers.forEach(server => {
                outbounds.push({
                    "type": "trojan",
                    "tag": server.name,
                    "server": server.domain,
                    "server_port": parseInt(server.port),
                    "password": server.password,
                    "tls": {
                        "enabled": true,
                        "server_name": server.domain,
                        "insecure": false
                    },
                    "multiplex": {
                        "enabled": true,
                        "protocol": "h2mux",
                        "max_connections": 4,
                        "min_streams": 4,
                        "padding": false
                    }
                });
            });
            
            outbounds.push(
                {
                    "type": "direct",
                    "tag": "direct"
                },
                {
                    "type": "block",
                    "tag": "block"
                }
            );
            
            return JSON.stringify({
                "log": {
                    "level": "info",
                    "timestamp": true
                },
                "dns": {
                    "servers": [
                        {
                            "tag": "google",
                            "address": "tls://8.8.8.8",
                            "detour": "proxy"
                        },
                        {
                            "tag": "local",
                            "address": "223.5.5.5",
                            "detour": "direct"
                        }
                    ],
                    "rules": [
                        {
                            "geosite": "cn",
                            "server": "local"
                        }
                    ],
                    "final": "google"
                },
                "inbounds": [
                    {
                        "type": "tun",
                        "tag": "tun-in",
                        "inet4_address": "172.19.0.1/30",
                        "inet6_address": "fdfe:dcba:9876::1/126",
                        "auto_route": true,
                        "strict_route": true,
                        "sniff": true,
                        "sniff_override_destination": true,
                        "stack": "system"
                    }
                ],
                "outbounds": outbounds,
                "route": {
                    "rules": [
                        {
                            "protocol": "dns",
                            "action": "hijack-dns"
                        },
                        {
                            "geosite": "category-ads-all",
                            "action": "reject"
                        },
                        {
                            "geoip": "private",
                            "outbound": "direct"
                        },
                        {
                            "geosite": "cn",
                            "geoip": "cn",
                            "outbound": "direct"
                        }
                    ],
                    "final": "proxy",
                    "auto_detect_interface": true
                },
                "experimental": {
                    "clash_api": {
                        "external_controller": "127.0.0.1:9090",
                        "external_ui": "ui",
                        "external_ui_download_url": "https://github.com/MetaCubeX/Yacd-meta/archive/gh-pages.zip",
                        "secret": apiSecret,
                        "default_mode": "rule"
                    }
                }
            }, null, 2);
        }

        // ç”Ÿæˆ Worker è„šæœ¬
        function generateWorkerScript(servers, subscriptionKey, apiSecret) {
            const clientConfig = JSON.parse(generateClientConfig(servers, apiSecret));
            
            return `// Cloudflare Worker è®¢é˜…æœåŠ¡
// è‡ªåŠ¨ç”Ÿæˆçš„é…ç½®ï¼ŒåŒ…å« ${servers.length} ä¸ªæœåŠ¡å™¨

addEventListener('fetch', event => {
    event.respondWith(handleRequest(event.request))
})

async function handleRequest(request) {
    const url = new URL(request.url)
    
    // éªŒè¯å¯†é’¥
    const AUTH_KEY = '${subscriptionKey}'
    if (url.searchParams.get('key') !== AUTH_KEY) {
        return new Response('Unauthorized', { status: 401 })
    }
    
    // sing-box å®¢æˆ·ç«¯é…ç½®
    const config = ${JSON.stringify(clientConfig, null, 4).split('\n').map((line, i) => i === 0 ? line : '    ' + line).join('\n')}
    
    return new Response(JSON.stringify(config, null, 2), {
        headers: {
            'Content-Type': 'application/json',
            'Cache-Control': 'no-cache',
            'Access-Control-Allow-Origin': '*'
        }
    })
}`;
        }

        // ç”Ÿæˆ Docker Compose
        function generateDockerCompose(server) {
            return `version: '3.8'

services:
  sing-box:
    image: ghcr.io/sagernet/sing-box:latest
    container_name: sing-box-${server.name.toLowerCase().replace(/[^a-z0-9]/g, '-')}
    restart: unless-stopped
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - ./config.json:/etc/sing-box/config.json:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - ./data:/var/lib/sing-box
    environment:
      - TZ=Asia/Shanghai
    command: run -c /etc/sing-box/config.json

  # Nginx ä¼ªè£…ç«™ç‚¹
  nginx:
    image: nginx:alpine
    container_name: nginx-fallback
    restart: unless-stopped
    ports:
      - "127.0.0.1:80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./html:/usr/share/nginx/html:ro

  # è¯ä¹¦è‡ªåŠ¨ç»­æœŸ
  certbot:
    image: certbot/certbot
    container_name: certbot
    volumes:
      - /etc/letsencrypt:/etc/letsencrypt
      - ./certbot:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
`;
        }

        // æ˜¾ç¤ºé…ç½®
        function displayConfigs() {
            const outputSection = document.getElementById('output-section');
            outputSection.style.display = 'block';
            
            const tabsContainer = document.getElementById('tabs');
            const outputsContainer = document.getElementById('config-outputs');
            
            tabsContainer.innerHTML = '';
            outputsContainer.innerHTML = '';
            
            let isFirst = true;
            for (const [filename, content] of Object.entries(generatedConfigs)) {
                // åˆ›å»ºæ ‡ç­¾
                const tab = document.createElement('button');
                tab.className = `tab ${isFirst ? 'active' : ''}`;
                tab.textContent = filename;
                tab.onclick = () => switchTab(filename);
                tabsContainer.appendChild(tab);
                
                // åˆ›å»ºè¾“å‡ºåŒºåŸŸ
                const outputDiv = document.createElement('div');
                outputDiv.id = `output-${filename}`;
                outputDiv.style.display = isFirst ? 'block' : 'none';
                outputDiv.innerHTML = `
                    <div class="config-output">
                        <button class="copy-btn" onclick="copyConfig('${filename}')">å¤åˆ¶</button>
                        <pre><code>${escapeHtml(content)}</code></pre>
                    </div>
                `;
                outputsContainer.appendChild(outputDiv);
                
                if (isFirst) {
                    currentTab = filename;
                    isFirst = false;
                }
            }
            
            // æ»šåŠ¨åˆ°è¾“å‡ºåŒºåŸŸ
            outputSection.scrollIntoView({ behavior: 'smooth' });
        }

        // åˆ‡æ¢æ ‡ç­¾
        function switchTab(filename) {
            // æ›´æ–°æ ‡ç­¾çŠ¶æ€
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.textContent === filename) {
                    tab.classList.add('active');
                }
            });
            
            // æ›´æ–°æ˜¾ç¤ºå†…å®¹
            document.querySelectorAll('[id^="output-"]').forEach(div => {
                div.style.display = 'none';
            });
            document.getElementById(`output-${filename}`).style.display = 'block';
            currentTab = filename;
        }

        // å¤åˆ¶é…ç½®
        function copyConfig(filename) {
            const content = generatedConfigs[filename];
            navigator.clipboard.writeText(content).then(() => {
                // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'âœ… å·²å¤åˆ¶';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }

        // å¤åˆ¶å½“å‰é…ç½®
        function copyCurrentConfig() {
            if (currentTab) {
                copyConfig(currentTab);
            }
        }

        // ä¸‹è½½æ‰€æœ‰é…ç½®
        function downloadAllConfigs() {
            const zip = new JSZip();
            const servers = collectServerData();
            
            // æ·»åŠ æ‰€æœ‰é…ç½®æ–‡ä»¶åˆ° ZIP
            for (const [filename, content] of Object.entries(generatedConfigs)) {
                // æ ¹æ®æ–‡ä»¶ç±»å‹ç»„ç»‡ç›®å½•
                if (filename.includes('server-')) {
                    const serverNum = filename.match(/server-(\d+)/)[1];
                    zip.folder(`server-${serverNum}`).file(filename.replace(/^server-\d+-/, ''), content);
                } else if (filename.includes('client')) {
                    zip.folder('client').file(filename, content);
                } else if (filename.includes('worker')) {
                    zip.folder('cloudflare').file(filename, content);
                } else if (filename.includes('docker')) {
                    const serverNum = filename.match(/server-(\d+)/)?.[1];
                    if (serverNum) {
                        zip.folder(`server-${serverNum}`).file('docker-compose.yml', content);
                    }
                }
            }
            
            // æ·»åŠ  README
            const readme = `# sing-box Trojan é…ç½®æ–‡ä»¶

ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}

## æœåŠ¡å™¨åˆ—è¡¨
${servers.map((s, i) => `- æœåŠ¡å™¨ ${i + 1}: ${s.name} (${s.domain})`).join('\n')}

## è®¢é˜…åœ°å€
https://your-worker.workers.dev/?key=${document.getElementById('subscriptionKey').value}

## Web UI
http://127.0.0.1:9090/ui
API Secret: ${document.getElementById('apiSecret').value}

## ä½¿ç”¨è¯´æ˜

### æœåŠ¡å™¨éƒ¨ç½²
1. å°† server-X æ–‡ä»¶å¤¹ä¸­çš„ install.sh ä¸Šä¼ åˆ°æœåŠ¡å™¨
2. æ‰§è¡Œ: chmod +x install.sh && ./install.sh
3. æˆ–ä½¿ç”¨ Docker Compose éƒ¨ç½²

### å®¢æˆ·ç«¯ä½¿ç”¨
1. ä½¿ç”¨ client/client-config.json é…ç½®æ–‡ä»¶
2. æˆ–é€šè¿‡è®¢é˜…é“¾æ¥å¯¼å…¥

### Cloudflare Worker
1. ç™»å½• Cloudflare Dashboard
2. åˆ›å»ºæ–°çš„ Worker
3. ç²˜è´´ cloudflare/cloudflare-worker.js å†…å®¹
4. éƒ¨ç½²

## å®‰å…¨æé†’
- è¯·å¦¥å–„ä¿ç®¡å¯†ç å’Œå¯†é’¥
- å®šæœŸæ›´æ–°è¯ä¹¦å’Œè½¯ä»¶ç‰ˆæœ¬
- ç›‘æ§æœåŠ¡å™¨çŠ¶æ€å’Œæ—¥å¿—
`;
            zip.file('README.md', readme);
            
            // ç”Ÿæˆå¹¶ä¸‹è½½ ZIP
            zip.generateAsync({ type: 'blob' }).then(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sing-box-config-${new Date().getTime()}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
        }

        // è¾…åŠ©å‡½æ•°
        function generateRandomString(length) {
            const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            return result;
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>